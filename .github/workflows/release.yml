name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Run all tests
        run: |
          cargo test --all-features --verbose
          cargo clippy --all-features -- -D warnings
          cargo fmt -- --check

      - name: Build documentation
        run: cargo doc --all-features --no-deps

      - name: Security audit
        run: |
          cargo install cargo-audit
          cargo audit

      - name: Publish to crates.io
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: cargo publish --all-features

      - name: Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            Cargo.toml
            README.md
            LICENSE-MIT
            LICENSE-APACHE

      - name: Update README version
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: |
          # Checkout main branch for updates (release triggered on tag)
          git checkout main
          git pull origin main --rebase
          
          # Configure Git
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Extract version from tag (e.g., v0.3.0 -> 0.3.0)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Updating README to version $VERSION"
          
          # Replace 'eventix = "..."' with 'eventix = "$VERSION"', preserving indentation
          sed -i "s/^\([[:space:]]*\)eventix = \".*\"/\1eventix = \"$VERSION\"/" README.md
          
          # Check for changes
          if git diff --quiet README.md; then
            echo "No changes to README.md"
          else
            git commit -am "docs: update readme version to $VERSION [skip ci]"
            git push origin main
            
            # Export commit SHA for next step
            echo "README_COMMIT_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV
            echo "Pushed README update to main"
          fi

      - name: Sync README update to dev
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Syncing README update to dev..."
          
          git checkout dev
          git pull origin dev --rebase
          
          # Cherry-pick the specific commit from main
          # This ensures ONLY the readme version change is brought over, 
          # not the entire history of main if it differs.
          if [ -n "${{ env.README_COMMIT_SHA }}" ]; then
             git cherry-pick ${{ env.README_COMMIT_SHA }}
             git push origin dev
             echo "Cherry-picked readme update to dev"
          else
             echo "No readme change to sync"
          fi
